# 검키우기 매크로

카카오톡 "검키우기" 챗봇 게임용 강화 자동화 매크로입니다.

## 주요 기능

- **자동 강화**: 채팅 메시지를 분석하여 강화 결과(성공/유지/파괴) 감지
- **목표 레벨 강화**: 설정한 목표 레벨까지 자동으로 계속 강화 시도
- **실시간 통계**: 성공률, 골드 변화, 레벨 분포 차트
- **GUI 대시보드**: Tkinter 기반 직관적인 인터페이스
- **단축키 지원**: F1-F5 핫키로 빠른 조작

## 요구 사항

- Windows 10/11
- Python 3.11 이상 (EXE 사용 시 불필요)
- 디스플레이 배율 100% 설정 필수

---

## 빌드 방법

### 방법 1: EXE 파일 직접 빌드

Python이 설치된 Windows 환경에서 EXE 파일을 빌드할 수 있습니다.

```batch
# 1. 저장소 클론
git clone https://github.com/heeJNa/sword-growing-kakao.git
cd sword-growing-kakao

# 2. 의존성 설치
pip install -r requirements.txt
pip install pyinstaller

# 3. EXE 빌드
scripts\build.bat
```

빌드 완료 후 `dist\SwordMacro.exe` 파일이 생성됩니다 (약 30-40MB).

### 방법 2: 소스에서 직접 실행

```batch
# 1. 저장소 클론
git clone https://github.com/heeJNa/sword-growing-kakao.git
cd sword-growing-kakao

# 2. 의존성 설치
pip install -r requirements.txt

# 3. 실행
python -m src.main_gui
```

---

## 사용 방법

### 1단계: 사전 준비

1. **디스플레이 설정 확인**

   - Windows 설정 → 디스플레이 → 배율 및 레이아웃 → **100%** 설정
   - 100%가 아니면 좌표가 맞지 않습니다

2. **카카오톡 준비**
   - 카카오톡 PC 버전 실행
   - "검키우기" 챗봇 채팅방 열기
   - 채팅창이 화면에 보이도록 배치

### 2단계: 매크로 실행

```batch
# EXE 파일 사용 시
SwordMacro.exe

# 또는 Python으로 직접 실행
python -m src.main_gui
```

### 3단계: 좌표 캘리브레이션 (최초 1회)

1. 매크로 실행 후 **F5** 키 또는 "캘리브레이션" 버튼 클릭
2. 안내에 따라 다음 위치를 클릭:
   - **채팅 입력창**: 메시지를 입력하는 텍스트 박스
   - **채팅 영역**: 채팅 메시지가 표시되는 영역
3. 좌표가 `~/.sword-macro/coordinates.json`에 저장됩니다

### 4단계: 자동 강화 시작

1. **F1** 키 또는 "자동 시작" 버튼 클릭
2. 매크로가 자동으로:
   - 채팅 내용 복사 (Ctrl+A → Ctrl+C)
   - 강화 결과 분석 (성공/유지/파괴)
   - 목표 레벨까지 계속 "강화" 입력
   - 파괴 시 0강에서 자동 재시작
3. 목표 레벨 도달 시 자동 일시정지
4. **F2** 키로 일시 정지, **ESC**로 종료

### 수동 모드

자동 모드 대신 수동으로 조작할 수도 있습니다:

- **F3**: 수동 강화 (채팅창에 "강화" 입력)
- **F4**: 수동 판매 (채팅창에 "판매" 입력)

---

## 단축키

| 키  | 기능              |
| --- | ----------------- |
| F1  | 자동 모드 시작    |
| F2  | 일시 정지         |
| F3  | 수동 강화         |
| F4  | 수동 판매         |
| F5  | 좌표 캘리브레이션 |
| ESC | 종료              |

---

## GUI 화면 구성

```
┌─────────────────────────────────────────────┐
│  상태 패널: 현재 레벨, 골드, 연속 실패 횟수    │
├─────────────────────────────────────────────┤
│  통계 패널: 총 시도, 성공률, 파괴 횟수        │
├─────────────────────────────────────────────┤
│  차트: 레벨별 확률 / 골드 변화 그래프         │
├─────────────────────────────────────────────┤
│  로그 패널: 실시간 강화 기록                  │
├─────────────────────────────────────────────┤
│  컨트롤: [자동시작] [정지] [강화] [판매]      │
└─────────────────────────────────────────────┘
```

---

## 설정 파일

설정 파일은 `~/.sword-macro/` 디렉토리에 저장됩니다:

| 파일               | 설명                        |
| ------------------ | --------------------------- |
| `settings.json`    | 전략 파라미터, 딜레이 설정  |
| `coordinates.json` | 채팅창 클릭 좌표            |
| `stats/sessions/`  | 세션별 통계 기록 (JSON/CSV) |

### settings.json 예시

```json
{
  "target_level": 15,
  "sell_on_target": false,
  "pause_on_target": true,
  "min_gold": 1000,
  "action_delay": 1.0,
  "click_delay": 0.1
}
```

---

## 전략 설명

이 매크로는 **목표 레벨까지 계속 강화**하는 것이 핵심입니다.

### 동작 방식

```
시작 (0강) → 강화 → 성공/유지/파괴
                    ↓
            성공: 레벨 +1 → 목표 도달? → 일시정지
            유지: 레벨 유지 → 계속 강화
            파괴: 0강으로 → 처음부터 다시 강화
```

### 전략 설정 항목

| 항목              | 기본값 | 설명                                   |
| ----------------- | ------ | -------------------------------------- |
| `target_level`    | 15     | 목표 강화 레벨 (이 레벨까지 계속 강화) |
| `sell_on_target`  | false  | 목표 도달 시 판매 여부 (보통 false)    |
| `pause_on_target` | true   | 목표 도달 시 일시정지 (확인용)         |
| `min_gold`        | 1000   | 최소 골드 (이하면 판매하여 자금 확보)  |

### 프리셋 전략

| 전략                 | 목표 레벨 | 설명                                    |
| -------------------- | --------- | --------------------------------------- |
| **안전 강화**        | 10강      | 낮은 목표, 안전하게                     |
| **목표 강화** (기본) | 15강      | 균형잡힌 목표                           |
| **최고 강화**        | 20강      | 최대 레벨 도전                          |
| **무한 반복**        | 12강      | 목표 도달 시 판매 후 재시작 (골드 파밍) |

---

## 문제 해결

### 좌표가 맞지 않아요

- 디스플레이 배율이 100%인지 확인
- F5로 좌표 재설정

### 한글이 입력되지 않아요

- 관리자 권한으로 실행
- 한글 키보드가 활성화되어 있는지 확인

### 채팅 내용을 읽지 못해요

- 카카오톡 창이 화면에 보이는지 확인
- 다른 창에 가려져 있으면 안 됩니다

### EXE 실행 시 백신 경고

- PyInstaller로 빌드된 EXE는 일부 백신에서 오탐지될 수 있음
- 신뢰할 수 있는 경우 예외 처리 추가

---

## 프로젝트 구조

```
src/
├── core/           # 핵심 로직 (상태, 파서, 액션, 매크로)
├── automation/     # 자동화 (키보드, 마우스, 클립보드, 핫키)
├── strategy/       # 전략 (휴리스틱 기반)
├── stats/          # 통계 수집
├── gui/            # GUI (위젯, 차트, 다이얼로그)
└── config/         # 설정 관리
```

---

## 아키텍처

### 클래스 구조

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              MacroRunner                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│ Dependencies (주입)                                                          │
│  ├── coords: Coordinates        # 화면 좌표 (클릭 위치)                       │
│  ├── settings: Settings         # 딜레이, 목표 레벨 등 설정                    │
│  ├── strategy: Strategy         # 결정 전략 (HeuristicStrategy)              │
│  └── stats: StatsCollector      # 통계 수집                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│ State (상태)                                                                 │
│  ├── game_state: GameState      # 게임 상태 (level, gold, fail_count)        │
│  └── macro_state: MacroState    # 매크로 상태 (IDLE/RUNNING/PAUSED/STOPPED)   │
├─────────────────────────────────────────────────────────────────────────────┤
│ Threading (스레드 제어)                                                       │
│  ├── _thread: Thread            # 백그라운드 스레드                           │
│  ├── _stop_event: Event         # 정지 신호                                  │
│  └── _pause_event: Event        # 일시정지 신호                               │
├─────────────────────────────────────────────────────────────────────────────┤
│ Callbacks (GUI 연동)                                                         │
│  ├── _on_state_change           # 게임 상태 변경 시                           │
│  ├── _on_result                 # 강화 결과 시                                │
│  ├── _on_status_change          # 매크로 상태 변경 시                          │
│  └── _on_error                  # 에러 발생 시                                │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 자동 모드 메인 루프 플로우

```
┌──────────────────┐
│   start_auto()   │ ──▶ 백그라운드 스레드 생성
└────────┬─────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│  초기화: /프로필 명령 → 현재 레벨/골드 파싱 → 세션 시작      │
└─────────────────────────────────────────────────────────────┘
         │
         ▼
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃              메인 루프 (while not stop_event)               ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┯━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
                              │
      ┌───────────────────────┼───────────────────────┐
      ▼                       ▼                       ▼
┌─────────────┐        ┌─────────────┐        ┌─────────────┐
│  골드 체크   │        │  전략 결정   │        │  액션 실행   │
│ gold < min? │ ──No─▶ │ ENHANCE/    │ ──▶    │ enhance()   │
│     │       │        │ SELL/WAIT   │        │ or sell()   │
│    Yes      │        └─────────────┘        └──────┬──────┘
│     ▼       │                                      │
│  [종료]     │                                      ▼
└─────────────┘                              ┌─────────────────┐
                                             │  결과 읽기       │
                                             │  클립보드 복사   │
                                             │  → parse_chat() │
                                             └────────┬────────┘
                                                      │
      ┌───────────────────────────────────────────────┘
      ▼
┌─────────────────────────────────────────────────────────────┐
│  파싱 실패 시 재시도 전략                                    │
│  • 1-2회: 기본 y_offset                                     │
│  • 3-4회: y_offset 조정 (-40/-70)                           │
│  • 5-6회: y_offset +10                                      │
│  • 최종 실패: /프로필 확인으로 상태 추론                      │
└─────────────────────────────────────────────────────────────┘
      │
      ▼
┌─────────────────────────────────────────────────────────────┐
│  상태 업데이트: game_state.update_from_result()              │
│  통계 기록: stats.record_enhance()                           │
│  콜백 호출: _notify_result(), _notify_state_change()        │
└─────────────────────────────────────────────────────────────┘
      │
      └──────────────────▶ [루프 반복]
```

### 액션 실행 흐름

```
┌─────────────────────────────────────────────────────────────┐
│                    enhance() / sell()                        │
└────────────────────────────┬────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│  1. 채팅 입력창 클릭 (chat_input_x, chat_input_y)            │
│  2. 명령어 입력 ("/강화" 또는 "/판매")                        │
│     • macOS: AppleScript (TSM 크래시 방지)                   │
│     • Windows: pynput.keyboard.type()                        │
│  3. Enter 키 전송                                            │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                     check_status()                           │
└────────────────────────────┬────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│  1. 채팅 출력창 클릭 (chat_output_x, chat_output_y + offset) │
│  2. Ctrl/Cmd + A (전체 선택)                                 │
│  3. Ctrl/Cmd + C (복사)                                      │
│  4. 클립보드 내용 반환                                        │
└─────────────────────────────────────────────────────────────┘
```

### 결과 파싱 흐름

```
parse_chat(chat_text)
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│  정규식 패턴 매칭                                            │
│  • SUCCESS: 〖 ✨ 강화 성공 ✨ +N → +M 〗                      │
│  • MAINTAIN: 〖 💦 강화 유지 💦 〗                            │
│  • DESTROY: 〖 💥 강화 파괴 💥 〗                             │
│  + 골드 추출: "보유 골드: N G"                                │
│  + 레벨 추출: "+N강" 패턴                                    │
└────────────────────────────┬────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│  game_state.update_from_result()                             │
│  • SUCCESS: level = parsed_level, fail_count = 0             │
│  • MAINTAIN: level 유지, fail_count += 1                     │
│  • DESTROY: level = 0, fail_count = 0                        │
└─────────────────────────────────────────────────────────────┘
```

### 에러 복구 전략

| 단계 | 조건 | 동작 |
|------|------|------|
| 클립보드 재시도 | 빈 클립보드 또는 이전과 동일 | 최대 3회 재시도 |
| 파싱 재시도 | UNKNOWN 결과 | y_offset 조정하며 최대 6회 |
| 프로필 폴백 | 파싱 6회 실패 | /프로필로 레벨 변화 추론 |
| 연속 에러 | 예외 5회 연속 | 루프 종료 (ERROR 상태) |

### 스레드 제어

```
Main Thread (GUI)                    Background Thread
      │                                     │
start_auto() ──────────────────▶ _auto_loop() 시작
      │                                     │
pause() ──── _pause_event.clear() ────▶ wait() 블로킹
      │                                     │
resume() ─── _pause_event.set() ──────▶ 루프 재개
      │                                     │
stop() ───── _stop_event.set() ───────▶ 루프 종료
      │                                     │
      │◀────── thread.join(5s) ─────────────┤
      ▼                                     ▼
```

---

## 주의 사항

- 관리자 권한으로 실행 권장
- 카카오톡 창이 화면에 보이는 상태에서 사용
- 매크로 실행 중에는 마우스/키보드 사용 자제
- 게임 이용약관을 확인하고 본인 책임 하에 사용

## 라이선스

MIT License
