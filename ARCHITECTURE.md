# 검키우기 강화 매크로 - 작동 원리 및 로직

## 목차

1. [시스템 개요](#1-시스템-개요)
2. [핵심 컴포넌트](#2-핵심-컴포넌트)
3. [작동 흐름](#3-작동-흐름)
4. [상태 머신](#4-상태-머신)
5. [채팅 파싱 로직](#5-채팅-파싱-로직)
6. [의사결정 알고리즘](#6-의사결정-알고리즘)
7. [자동화 메커니즘](#7-자동화-메커니즘)
8. [데이터 흐름](#8-데이터-흐름)
9. [에러 처리](#9-에러-처리)

---

## 1. 시스템 개요

### 1.1 매크로란?

검키우기 매크로는 카카오톡 PC버전에서 실행되는 "검키우기" 챗봇 게임의 반복 작업을 자동화하는 프로그램입니다.

```
┌─────────────────────────────────────────────────────────────┐
│                      사용자 컴퓨터                            │
│  ┌─────────────┐      ┌─────────────┐      ┌─────────────┐  │
│  │   매크로     │ ──▶  │  카카오톡    │ ──▶  │  검키우기    │  │
│  │  (Python)   │ ◀──  │   (PC앱)    │ ◀──  │   (챗봇)    │  │
│  └─────────────┘      └─────────────┘      └─────────────┘  │
│        │                    │                               │
│        ▼                    ▼                               │
│   키보드/마우스          채팅 메시지                          │
│     입력 전송             읽기                               │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 작동 방식 요약

| 단계 | 설명 |
|------|------|
| **1. 감지** | 단축키 입력 또는 자동 루프 트리거 |
| **2. 읽기** | 채팅창에서 현재 게임 상태 파싱 |
| **3. 결정** | 전략에 따라 다음 행동 결정 |
| **4. 실행** | 키보드/마우스로 명령 입력 |
| **5. 대기** | 응답 수신 후 다음 사이클 |

---

## 2. 핵심 컴포넌트

### 2.1 컴포넌트 구조도

```
┌──────────────────────────────────────────────────────────────────┐
│                         Main (main.py)                           │
│                    프로그램 진입점 및 초기화                        │
└───────────────────────────────┬──────────────────────────────────┘
                                │
        ┌───────────────────────┼───────────────────────┐
        ▼                       ▼                       ▼
┌───────────────┐      ┌───────────────┐      ┌───────────────┐
│   Hotkeys     │      │    Macro      │      │   Strategy    │
│  (hotkeys.py) │      │  (macro.py)   │      │ (heuristic.py)│
│               │      │               │      │               │
│ - 단축키 감지   │      │ - 메인 루프    │      │ - 의사결정     │
│ - 콜백 실행    │      │ - 상태 관리    │      │ - 전략 계산    │
└───────┬───────┘      └───────┬───────┘      └───────┬───────┘
        │                      │                      │
        │              ┌───────┴───────┐              │
        │              ▼               ▼              │
        │      ┌───────────┐   ┌───────────┐         │
        │      │  Parser   │   │  Actions  │         │
        │      │(parser.py)│   │(actions.py│         │
        │      │           │   │           │         │
        │      │- 텍스트    │   │- 강화 실행 │         │
        │      │  파싱     │   │- 판매 실행 │         │
        │      └─────┬─────┘   └─────┬─────┘         │
        │            │               │               │
        │            ▼               ▼               │
        │      ┌─────────────────────────────┐       │
        │      │       Automation Layer       │       │
        │      │  keyboard.py | mouse.py     │       │
        │      │  clipboard.py               │       │
        │      └─────────────────────────────┘       │
        │                    │                       │
        └────────────────────┼───────────────────────┘
                             ▼
                    ┌───────────────┐
                    │   Config      │
                    │ (settings.py) │
                    │ (coordinates) │
                    │ (game_data)   │
                    └───────────────┘
```

### 2.2 각 컴포넌트 역할

| 컴포넌트 | 파일 | 역할 | 의존성 |
|----------|------|------|--------|
| **Main** | main.py | 프로그램 시작, CLI 처리 | 모든 컴포넌트 |
| **Hotkeys** | hotkeys.py | 키보드 단축키 감지 | pynput |
| **Macro** | macro.py | 자동 루프 실행 | Parser, Actions, Strategy |
| **Parser** | parser.py | 채팅 메시지 해석 | 정규표현식 |
| **Actions** | actions.py | 게임 명령 실행 | Automation Layer |
| **Strategy** | heuristic.py | 행동 결정 로직 | Config |
| **Automation** | keyboard.py, mouse.py, win32_automation.py | OS 입력 제어 | pywin32 (Win32 API) |
| **Config** | settings.py, coordinates.py | 설정값 저장 | 없음 |

---

## 3. 작동 흐름

### 3.1 수동 모드 (Phase 1)

```
┌─────────────────────────────────────────────────────────────┐
│                     수동 모드 흐름도                          │
└─────────────────────────────────────────────────────────────┘

사용자 ──▶ [F1 키 입력] ──▶ HotkeyListener
                                  │
                                  ▼
                          콜백 함수 호출
                                  │
                                  ▼
                          enhance() 실행
                                  │
                    ┌─────────────┴─────────────┐
                    ▼                           ▼
            click_at(CHAT_INPUT)         type_korean("/ㄱ")
                    │                           │
                    └─────────────┬─────────────┘
                                  ▼
                          채팅창에 입력 완료
                                  │
                                  ▼
                          검키우기 봇 응답
                                  │
                                  ▼
                          (다음 사용자 입력 대기)
```

### 3.2 자동 모드 (Phase 2)

```
┌─────────────────────────────────────────────────────────────┐
│                     자동 모드 흐름도                          │
└─────────────────────────────────────────────────────────────┘

[F3 키: 자동 루프 시작]
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│                    MacroRunner._loop()                       │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                    WHILE running:                    │    │
│  │                                                      │    │
│  │  ┌──────────────────────────────────────────────┐   │    │
│  │  │ 1. 채팅 읽기                                   │   │    │
│  │  │    chat_text = copy_chat_output()            │   │    │
│  │  └───────────────────┬──────────────────────────┘   │    │
│  │                      ▼                              │    │
│  │  ┌──────────────────────────────────────────────┐   │    │
│  │  │ 2. 상태 파싱                                   │   │    │
│  │  │    result, state = parse_chat(chat_text)     │   │    │
│  │  └───────────────────┬──────────────────────────┘   │    │
│  │                      ▼                              │    │
│  │  ┌──────────────────────────────────────────────┐   │    │
│  │  │ 3. 전략 적용                                   │   │    │
│  │  │    action = strategy.decide(state)           │   │    │
│  │  └───────────────────┬──────────────────────────┘   │    │
│  │                      ▼                              │    │
│  │  ┌──────────────────────────────────────────────┐   │    │
│  │  │ 4. 행동 실행                                   │   │    │
│  │  │    if action == ENHANCE: enhance()           │   │    │
│  │  │    elif action == SELL: sell()               │   │    │
│  │  └───────────────────┬──────────────────────────┘   │    │
│  │                      ▼                              │    │
│  │  ┌──────────────────────────────────────────────┐   │    │
│  │  │ 5. 대기                                        │   │    │
│  │  │    time.sleep(ACTION_DELAY)                  │   │    │
│  │  └───────────────────┬──────────────────────────┘   │    │
│  │                      │                              │    │
│  │                      ▼                              │    │
│  │               (루프 반복)                           │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
         │
         ▼
[F5 키: 종료] ──▶ running = False ──▶ 루프 탈출
```

---

## 4. 상태 머신

### 4.1 게임 상태 정의

```python
@dataclass
class GameState:
    level: int = 0           # 현재 강화 레벨 (0-20)
    gold: int = 0            # 보유 골드
    fail_count: int = 0      # 연속 실패 횟수
    last_result: EnhanceResult = None  # 마지막 강화 결과
```

### 4.2 상태 전이 다이어그램

```
                    ┌────────────────────────────────────────┐
                    │           게임 상태 전이도               │
                    └────────────────────────────────────────┘

                              [초기 상태]
                                  │
                                  ▼
                    ┌─────────────────────────┐
                    │    level=0, gold=N      │
                    │    fail_count=0         │
                    └────────────┬────────────┘
                                 │
                          ┌──────┴──────┐
                          ▼             ▼
                    [강화 실행]      [판매 실행]
                          │             │
           ┌──────────────┼─────────────┤
           ▼              ▼             ▼
      ┌─────────┐   ┌─────────┐   ┌─────────┐
      │  성공    │   │  유지    │   │  파괴    │
      │         │   │         │   │         │
      │level++  │   │fail++   │   │level=0  │
      │fail=0   │   │         │   │fail=0   │
      └────┬────┘   └────┬────┘   └────┬────┘
           │             │             │
           └──────────────┼─────────────┘
                         ▼
              ┌─────────────────────┐
              │   다음 행동 결정      │
              │   (Strategy 호출)    │
              └──────────┬──────────┘
                         │
              ┌──────────┴──────────┐
              ▼                     ▼
         [강화 계속]            [판매 실행]
              │                     │
              │                     ▼
              │          ┌─────────────────┐
              │          │ gold += sell_price │
              │          │ level = 0        │
              │          └────────┬────────┘
              │                   │
              └───────────────────┘
                         │
                         ▼
                  (루프 반복)
```

### 4.3 강화 결과 타입

```
┌─────────────────────────────────────────────────────────────┐
│                    EnhanceResult Enum                        │
├─────────────┬───────────────────────────────────────────────┤
│   SUCCESS   │ 강화 성공 → level + 1                          │
├─────────────┼───────────────────────────────────────────────┤
│   MAINTAIN  │ 강화 실패 (유지) → level 유지, fail_count + 1  │
├─────────────┼───────────────────────────────────────────────┤
│   DESTROY   │ 강화 실패 (파괴) → level = 0                   │
├─────────────┼───────────────────────────────────────────────┤
│   UNKNOWN   │ 파싱 실패 → 재시도 또는 대기                    │
└─────────────┴───────────────────────────────────────────────┘
```

---

## 5. 채팅 파싱 로직

### 5.1 파싱 대상

검키우기 챗봇은 다음과 같은 메시지를 전송합니다:

```
[강화 성공 예시]
🗡️ +5강 강화에 성공했습니다!
현재 골드: 50,000원

[강화 실패 (유지) 예시]
❌ 강화에 실패했습니다.
레벨이 유지됩니다.
현재 골드: 49,000원

[강화 실패 (파괴) 예시]
💥 강화에 실패하여 검이 파괴되었습니다.
0강부터 다시 시작합니다.
현재 골드: 48,000원

[판매 예시]
💰 +10강 검을 100,000원에 판매했습니다.
현재 골드: 148,000원
```

### 5.2 정규표현식 패턴

```python
# 파싱 패턴 정의
PATTERNS = {
    # 성공 패턴: "+N강" + "성공"
    "success": r'\+(\d+)강.*성공',

    # 실패 (유지) 패턴
    "maintain": r'(실패|유지).*레벨.*유지',

    # 파괴 패턴
    "destroy": r'(파괴|부서|0강.*시작)',

    # 골드 추출: 숫자 + (골드|원|G)
    "gold": r'(\d{1,3}(?:,\d{3})*)\s*(골드|원|G)',

    # 레벨 추출: +N강
    "level": r'\+(\d+)강',

    # 판매 패턴
    "sell": r'판매.*(\d{1,3}(?:,\d{3})*)\s*원'
}
```

### 5.3 파싱 흐름도

```
┌─────────────────────────────────────────────────────────────┐
│                    parse_chat() 함수                         │
└─────────────────────────────────────────────────────────────┘

입력: chat_text (채팅창 텍스트)
         │
         ▼
┌─────────────────────────────────────┐
│ Step 1: 텍스트 정규화                 │
│ - 공백 정리                          │
│ - 줄바꿈 처리                        │
└───────────────────┬─────────────────┘
                    ▼
┌─────────────────────────────────────┐
│ Step 2: 결과 타입 판별               │
│                                     │
│ if re.search(DESTROY):              │
│     result = DESTROY                │
│ elif re.search(SUCCESS):            │
│     result = SUCCESS                │
│     level = extract_level()         │
│ elif re.search(MAINTAIN):           │
│     result = MAINTAIN               │
│ else:                               │
│     result = UNKNOWN                │
└───────────────────┬─────────────────┘
                    ▼
┌─────────────────────────────────────┐
│ Step 3: 골드 추출                    │
│                                     │
│ gold_match = re.search(GOLD)        │
│ if gold_match:                      │
│     gold = parse_int(gold_match)    │
└───────────────────┬─────────────────┘
                    ▼
┌─────────────────────────────────────┐
│ Step 4: 상태 객체 생성               │
│                                     │
│ state = GameState(                  │
│     level=level,                    │
│     gold=gold,                      │
│     ...                             │
│ )                                   │
└───────────────────┬─────────────────┘
                    ▼
출력: (EnhanceResult, GameState)
```

---

## 6. 의사결정 알고리즘

### 6.1 휴리스틱 전략 로직

```
┌─────────────────────────────────────────────────────────────┐
│              HeuristicStrategy.decide() 알고리즘             │
└─────────────────────────────────────────────────────────────┘

입력: GameState(level, gold, fail_count)
파라미터: level_threshold, max_fails, min_gold

         ┌────────────────┐
         │ 상태 입력 받음  │
         └───────┬────────┘
                 ▼
         ┌────────────────────────┐
         │ gold < min_gold ?      │
         └───────┬────────────────┘
                 │
         ┌───────┴───────┐
         │ YES           │ NO
         ▼               ▼
    ┌─────────┐   ┌────────────────────────┐
    │ SELL    │   │ level >= max_level ?   │
    │ (판매)   │   │ (예: 20)               │
    └─────────┘   └───────┬────────────────┘
                          │
                  ┌───────┴───────┐
                  │ YES           │ NO
                  ▼               ▼
             ┌─────────┐   ┌────────────────────────┐
             │ SELL    │   │ level >= threshold     │
             │ (판매)   │   │ AND                    │
             └─────────┘   │ fail_count >= max_fails│
                          └───────┬────────────────┘
                                  │
                          ┌───────┴───────┐
                          │ YES           │ NO
                          ▼               ▼
                     ┌─────────┐    ┌──────────┐
                     │ SELL    │    │ ENHANCE  │
                     │ (판매)   │    │ (강화)   │
                     └─────────┘    └──────────┘
```

### 6.2 의사결정 테이블

| 조건 | level | gold | fail_count | 결정 |
|------|-------|------|------------|------|
| 자금 부족 | any | < 10,000 | any | **SELL** |
| 최대 레벨 | 20 | any | any | **SELL** |
| 임계값 + 실패 | >= 11 | >= 10,000 | >= 2 | **SELL** |
| 그 외 | any | >= 10,000 | any | **ENHANCE** |

### 6.3 전략 파라미터

```python
# 기본 설정값
DEFAULT_STRATEGY_CONFIG = {
    "level_threshold": 11,    # 이 레벨 이상에서 실패 횟수 체크
    "max_fails": 2,           # 최대 허용 연속 실패 횟수
    "min_gold": 10000,        # 최소 필요 골드
    "max_level": 20,          # 최대 강화 레벨
}
```

### 6.4 기대값 기반 분석 (참고)

```
강화 기대값 계산:

E[강화] = P(성공) × (다음레벨 가치 - 비용)
       + P(유지) × (-비용)
       + P(파괴) × (-현재가치 - 비용)

판매 기대값:
E[판매] = 현재 판매가

결정 규칙:
if E[강화] > E[판매]:
    return ENHANCE
else:
    return SELL
```

| Level | P(성공) | P(유지) | P(파괴) | 비용 | 판매가 | 휴리스틱 결정 |
|-------|---------|---------|---------|------|--------|--------------|
| 5 | 75% | 25% | 0% | 3,000 | 2,500 | 강화 |
| 10 | 50% | 45% | 5% | 80,000 | 60,000 | 상황별 |
| 15 | 15% | 25% | 60% | 2,000,000 | 3,000,000 | 신중히 |

---

## 7. 자동화 메커니즘

### 7.1 키보드 입력 방식

```
┌─────────────────────────────────────────────────────────────┐
│                    키보드 입력 흐름                           │
└─────────────────────────────────────────────────────────────┘

[한글 입력이 필요한 경우] - "/ㄱ", "/판" 등

         ┌───────────────────────┐
         │ 입력할 텍스트: "/ㄱ"   │
         └───────────┬───────────┘
                     ▼
         ┌───────────────────────────────────┐
         │ win32clipboard.SetClipboardData() │  ← 클립보드에 복사
         └───────────┬───────────────────────┘
                     ▼
         ┌───────────────────────────────────┐
         │ Win32Window.send_ctrl_key('v')    │  ← Ctrl+V (PostMessage)
         └───────────┬───────────────────────┘
                     ▼
         ┌───────────────────────────────────┐
         │ Win32Window.send_key(VK_RETURN)   │  ← Enter 키로 전송
         └───────────────────────────────────┘


[영문/숫자만 입력하는 경우]

         ┌───────────────────────────────────┐
         │ win32api.keybd_event()            │  ← Win32 키보드 이벤트
         └───────────────────────────────────┘
```

### 7.2 마우스 제어 방식

```
┌─────────────────────────────────────────────────────────────┐
│                    마우스 클릭 흐름 (RDP 호환)                  │
└─────────────────────────────────────────────────────────────┘

         ┌───────────────────────┐
         │ 대상 좌표: (x, y)      │  ← coordinates.py에서 로드 (화면 좌표)
         └───────────┬───────────┘
                     ▼
         ┌─────────────────────────────────────┐
         │ Win32Window.screen_to_client(x, y)  │  ← 클라이언트 좌표로 변환
         └───────────┬─────────────────────────┘
                     ▼
         ┌─────────────────────────────────────┐
         │ Win32Window.click(client_x, client_y)│
         │                                     │
         │ → PostMessage(WM_LBUTTONDOWN)       │  ← RDP 호환 클릭
         │ → PostMessage(WM_LBUTTONUP)         │
         └─────────────────────────────────────┘
```

### 7.3 채팅 읽기 방식

```
┌─────────────────────────────────────────────────────────────┐
│                    채팅 복사 흐름 (RDP 호환)                    │
└─────────────────────────────────────────────────────────────┘

         ┌───────────────────────┐
         │ 카카오톡 창 찾기        │
         │ WindowFinder.find_kakao_chat() │
         └───────────┬───────────┘
                     ▼
         ┌─────────────────────────────────────┐
         │ 채팅 출력 영역 클릭                   │
         │ Win32Window.click(client_x, client_y)│
         └───────────┬─────────────────────────┘
                     ▼
         ┌─────────────────────────────────────┐
         │ 전체 선택 (PostMessage)              │
         │ Win32Window.send_ctrl_key('a')      │
         └───────────┬─────────────────────────┘
                     ▼
         ┌─────────────────────────────────────┐
         │ 복사 (PostMessage)                   │
         │ Win32Window.send_ctrl_key('c')      │
         └───────────┬─────────────────────────┘
                     ▼
         ┌─────────────────────────────────────┐
         │ 클립보드에서 텍스트 추출             │
         │ win32clipboard.GetClipboardData()   │
         └───────────┬─────────────────────────┘
                     ▼
         ┌───────────────────────┐
         │ 텍스트 반환            │
         └───────────────────────┘
```

### 7.4 좌표 설정

```
┌─────────────────────────────────────────────────────────────┐
│                    화면 좌표 구성                             │
└─────────────────────────────────────────────────────────────┘

카카오톡 PC 채팅창 구조:

┌──────────────────────────────────────┐
│  채팅방 제목                          │
├──────────────────────────────────────┤
│                                      │
│   채팅 출력 영역                      │ ← CHAT_OUTPUT (x1, y1)
│   (메시지 표시)                       │    전체 선택/복사 대상
│                                      │
│                                      │
├──────────────────────────────────────┤
│  [ 채팅 입력 영역                  ]  │ ← CHAT_INPUT (x2, y2)
│                                      │    명령어 입력 위치
└──────────────────────────────────────┘

# coordinates.py
CHAT_OUTPUT = (500, 400)  # 예시 좌표, 캘리브레이션 필요
CHAT_INPUT = (500, 700)   # 예시 좌표, 캘리브레이션 필요
```

---

## 8. 데이터 흐름

### 8.1 전체 데이터 흐름도

```
┌─────────────────────────────────────────────────────────────┐
│                      전체 데이터 흐름                         │
└─────────────────────────────────────────────────────────────┘

 [카카오톡]                      [매크로]                    [설정]
     │                             │                          │
     │  채팅 메시지                 │                          │
     │ ─────────────────────────▶  │                          │
     │                             │                          │
     │                    ┌────────┴────────┐                 │
     │                    │                 │                 │
     │                    ▼                 ▼                 │
     │              [clipboard]      [Parser 모듈]            │
     │                    │                 │                 │
     │                    │   텍스트 데이터  │                 │
     │                    └────────┬────────┘                 │
     │                             │                          │
     │                             ▼                          │
     │                    ┌─────────────────┐                 │
     │                    │   GameState     │                 │
     │                    │ {level, gold,   │                 │
     │                    │  fail_count}    │                 │
     │                    └────────┬────────┘                 │
     │                             │                          │
     │                             ▼                          │
     │                    ┌─────────────────┐       ┌────────┴────────┐
     │                    │    Strategy     │◀──────│ LEVEL_DATA      │
     │                    │   .decide()     │       │ THRESHOLDS      │
     │                    └────────┬────────┘       └─────────────────┘
     │                             │
     │                             ▼
     │                    ┌─────────────────┐
     │                    │     Action      │
     │                    │ (ENHANCE/SELL)  │
     │                    └────────┬────────┘
     │                             │
     │                             ▼
     │                    ┌─────────────────┐
     │                    │  Actions 모듈   │
     │                    │ enhance()/sell()│
     │                    └────────┬────────┘
     │                             │
     │                             ▼
     │                    ┌─────────────────┐
     │   키보드/마우스 입력 │  Automation    │
     │ ◀───────────────────│   Layer        │
     │                    └─────────────────┘
     │
     ▼
 [검키우기 봇 응답]
```

### 8.2 로깅 데이터

```python
# 실행 로그 형식
log_entry = {
    "timestamp": "2026-01-16T12:00:00",
    "action": "ENHANCE",
    "state_before": {
        "level": 10,
        "gold": 150000,
        "fail_count": 1
    },
    "result": "SUCCESS",
    "state_after": {
        "level": 11,
        "gold": 70000,
        "fail_count": 0
    }
}
```

---

## 9. 에러 처리

### 9.1 예상 에러 및 대응

```
┌─────────────────────────────────────────────────────────────┐
│                    에러 처리 흐름                             │
└─────────────────────────────────────────────────────────────┘

┌────────────────┬────────────────────┬────────────────────────┐
│     에러 유형   │        원인         │        대응            │
├────────────────┼────────────────────┼────────────────────────┤
│ 파싱 실패       │ 예상 외 메시지 형식  │ UNKNOWN 반환 → 재시도  │
│                │                    │ 3회 실패 시 일시 정지   │
├────────────────┼────────────────────┼────────────────────────┤
│ 클릭 실패       │ 좌표 불일치         │ 캘리브레이션 안내       │
│                │ 창 위치 변경        │ 사용자 확인 요청        │
├────────────────┼────────────────────┼────────────────────────┤
│ 입력 실패       │ 포커스 이탈         │ 채팅창 재클릭 후 재시도 │
│                │ 한글 입력기 문제    │ Win32 클립보드 방식     │
├────────────────┼────────────────────┼────────────────────────┤
│ 권한 에러       │ 관리자 권한 없음    │ 관리자 권한 실행 안내   │
│                │                    │ 프로그램 종료           │
├────────────────┼────────────────────┼────────────────────────┤
│ 타임아웃        │ 봇 응답 지연        │ 대기 시간 증가          │
│                │ 네트워크 문제       │ 최대 10초 후 재시도     │
└────────────────┴────────────────────┴────────────────────────┘
```

### 9.2 에러 처리 코드 패턴

```python
def safe_action(action_func, max_retries=3, delay=1.0):
    """안전한 액션 실행 래퍼"""
    for attempt in range(max_retries):
        try:
            return action_func()
        except ParsingError:
            logging.warning(f"파싱 실패 (시도 {attempt + 1}/{max_retries})")
            time.sleep(delay)
        except AutomationError:
            logging.warning(f"자동화 에러 (시도 {attempt + 1}/{max_retries})")
            # 카카오톡 창 다시 찾기
            find_and_set_kakao_window()
            time.sleep(delay)

    raise MaxRetriesExceeded(f"{max_retries}회 시도 후 실패")
```

### 9.3 안전 장치

```python
# 비상 정지 메커니즘
PANIC_KEY = keyboard.Key.esc  # ESC 키로 즉시 중단

# 연속 에러 감지
MAX_CONSECUTIVE_ERRORS = 5
error_count = 0

def on_error():
    global error_count
    error_count += 1
    if error_count >= MAX_CONSECUTIVE_ERRORS:
        logging.critical("연속 에러 한도 초과 - 프로그램 중단")
        sys.exit(1)

def on_success():
    global error_count
    error_count = 0  # 성공 시 카운터 리셋
```

---

## 10. 통계 시스템 (Phase 4)

### 10.1 통계 데이터 구조

```
┌─────────────────────────────────────────────────────────────┐
│                    통계 데이터 계층 구조                       │
└─────────────────────────────────────────────────────────────┘

SessionStats (세션 통계)
├── start_time: datetime         # 세션 시작 시간
├── total_enhances: int          # 총 강화 시도 횟수
├── total_sells: int             # 총 판매 횟수
├── starting_gold: int           # 시작 골드
├── current_gold: int            # 현재 골드
├── max_level_reached: int       # 도달한 최고 레벨
│
└── level_stats: Dict[int, LevelStats]  # 레벨별 통계
    │
    └── LevelStats (레벨별 통계)
        ├── level: int               # 강화 레벨
        ├── success_count: int       # 성공 횟수
        ├── maintain_count: int      # 유지 횟수
        ├── destroy_count: int       # 파괴 횟수
        ├── total_attempts: int      # 총 시도 횟수
        │
        └── [계산 속성]
            ├── success_rate: float  # 성공률 (%)
            ├── maintain_rate: float # 유지율 (%)
            └── destroy_rate: float  # 파괴율 (%)
```

### 10.2 통계 수집 흐름

```
┌─────────────────────────────────────────────────────────────┐
│                    통계 수집 흐름도                           │
└─────────────────────────────────────────────────────────────┘

[강화 실행]
     │
     ▼
┌─────────────────┐
│ Parser.parse()  │  → EnhanceResult (SUCCESS/MAINTAIN/DESTROY)
└────────┬────────┘
         │
         ▼
┌─────────────────────────────────────┐
│ StatsCollector.record_enhance()     │
│                                     │
│ 1. 현재 레벨의 LevelStats 조회       │
│    (없으면 새로 생성)                │
│                                     │
│ 2. 결과에 따라 카운터 증가           │
│    - SUCCESS → success_count++      │
│    - MAINTAIN → maintain_count++    │
│    - DESTROY → destroy_count++      │
│                                     │
│ 3. total_attempts++                 │
│                                     │
│ 4. 세션 통계 업데이트                │
│    - total_enhances++               │
│    - max_level_reached 갱신         │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│ EnhanceRecord 생성 (히스토리)        │
│                                     │
│ {                                   │
│   timestamp: datetime,              │
│   level: int,                       │
│   result: EnhanceResult,            │
│   gold_before: int,                 │
│   gold_after: int                   │
│ }                                   │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│ Storage.append_record()             │
│ → JSON/CSV 파일에 기록              │
└─────────────────────────────────────┘
```

### 10.3 통계 계산 로직

```python
# 레벨별 실제 확률 계산
def calculate_actual_probability(level_stats: LevelStats) -> Dict[str, float]:
    """실제 관측된 확률 계산"""
    total = level_stats.total_attempts
    if total == 0:
        return {"success": 0, "maintain": 0, "destroy": 0}

    return {
        "success": level_stats.success_count / total * 100,
        "maintain": level_stats.maintain_count / total * 100,
        "destroy": level_stats.destroy_count / total * 100,
    }

# 이론값 vs 실제값 비교
def compare_with_theory(level: int, actual: Dict[str, float]) -> Dict[str, float]:
    """이론 확률과 실제 확률의 차이 계산"""
    theory = LEVEL_DATA[level]
    return {
        "success_diff": actual["success"] - theory["success"] * 100,
        "maintain_diff": actual["maintain"] - theory["maintain"] * 100,
        "destroy_diff": actual["destroy"] - theory["destroy"] * 100,
    }
```

### 10.4 수익률 분석

```
┌─────────────────────────────────────────────────────────────┐
│                    수익률 분석 지표                           │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────┬───────────────────────────────────────┐
│       지표          │               계산 공식                │
├─────────────────────┼───────────────────────────────────────┤
│ 총 수익 (Gross)     │ current_gold - starting_gold          │
├─────────────────────┼───────────────────────────────────────┤
│ ROI (%)             │ (수익 / starting_gold) × 100          │
├─────────────────────┼───────────────────────────────────────┤
│ 강화당 평균 수익     │ 총 수익 / total_enhances              │
├─────────────────────┼───────────────────────────────────────┤
│ 시간당 수익         │ 총 수익 / 실행 시간(시간)              │
├─────────────────────┼───────────────────────────────────────┤
│ 최적 판매 레벨      │ 수익이 가장 높았던 판매 레벨           │
└─────────────────────┴───────────────────────────────────────┘
```

### 10.5 데이터 저장 형식

```
data/stats/sessions/
├── session_2026-01-16_120000.json   # 세션 요약
└── session_2026-01-16_120000.csv    # 상세 기록

# JSON 형식 (세션 요약)
{
  "session_id": "2026-01-16_120000",
  "start_time": "2026-01-16T12:00:00",
  "end_time": "2026-01-16T13:30:00",
  "duration_minutes": 90,
  "summary": {
    "total_enhances": 500,
    "total_sells": 45,
    "starting_gold": 100000,
    "ending_gold": 250000,
    "profit": 150000,
    "roi_percent": 150.0
  },
  "level_stats": {
    "0": {"attempts": 50, "success": 49, "maintain": 1, "destroy": 0},
    "5": {"attempts": 80, "success": 58, "maintain": 22, "destroy": 0},
    "10": {"attempts": 40, "success": 18, "maintain": 18, "destroy": 4},
    ...
  }
}

# CSV 형식 (상세 기록)
timestamp,level,result,gold_before,gold_after
2026-01-16T12:00:01,0,SUCCESS,100000,99900
2026-01-16T12:00:03,1,SUCCESS,99900,99700
2026-01-16T12:00:05,2,MAINTAIN,99700,99300
...
```

---

## 11. GUI 대시보드 (Phase 5)

### 11.1 전체 구조

```
┌─────────────────────────────────────────────────────────────┐
│                    GUI 컴포넌트 구조                          │
└─────────────────────────────────────────────────────────────┘

MacroApp (메인 애플리케이션)
│
├── root: tk.Tk                    # Tkinter 루트 윈도우
│
├── Components (UI 컴포넌트)
│   ├── StatusPanel               # 현재 상태 표시
│   ├── StatsPanel                # 세션 통계 표시
│   ├── ChartPanel                # 차트 영역
│   │   ├── LevelProbabilityChart # 레벨별 확률 막대 차트
│   │   └── GoldHistoryChart      # 골드 변화 선 그래프
│   ├── LogPanel                  # 최근 기록 로그
│   └── ControlPanel              # 제어 버튼
│
├── Core (핵심 로직)
│   ├── MacroRunner               # 매크로 실행 쓰레드
│   ├── StatsCollector            # 통계 수집기
│   └── GUIUpdater                # UI 업데이트 관리자
│
└── Dialogs (다이얼로그)
    └── SettingsDialog            # 설정 창
```

### 11.2 메인 레이아웃

```
┌──────────────────────────────────────────────────────────────────────┐
│                      검키우기 매크로 대시보드                           │
├─────────────────────────┬────────────────────────────────────────────┤
│                         │                                            │
│   ┌─────────────────┐   │   ┌────────────────────────────────────┐   │
│   │  현재 상태       │   │   │                                    │   │
│   │                 │   │   │     레벨별 강화 확률 차트             │   │
│   │  레벨: +12강    │   │   │     (막대 그래프)                    │   │
│   │  골드: 500,000  │   │   │                                    │   │
│   │  상태: 🟢 실행중 │   │   │   100%┌──┐                         │   │
│   │                 │   │   │       │■ │  ┌──┐                   │   │
│   └─────────────────┘   │   │    50%│  │  │■ │  ┌──┐             │   │
│                         │   │       │  │  │  │  │■ │             │   │
│   ┌─────────────────┐   │   │     0%└──┴──┴──┴──┴──┴──           │   │
│   │  세션 통계       │   │   │       +5  +10  +15                  │   │
│   │                 │   │   │                                    │   │
│   │  총 강화: 150회  │   │   │   ■ 성공  ■ 유지  ■ 파괴           │   │
│   │  성공률: 65.3%  │   │   └────────────────────────────────────┘   │
│   │  수익: +50,000  │   │                                            │
│   │  ROI: +50%      │   │   ┌────────────────────────────────────┐   │
│   │                 │   │   │                                    │   │
│   │  최고 레벨: +15  │   │   │     골드 변화 추이                   │   │
│   │  실행 시간: 30분 │   │   │     (선 그래프)                     │   │
│   └─────────────────┘   │   │                                    │   │
│                         │   │   600K ────────────╱───            │   │
│                         │   │   400K ─────────╱─────             │   │
│                         │   │   200K ──────╱────────             │   │
│                         │   │      0 └──────────────────         │   │
│                         │   │        시간 →                       │   │
│                         │   └────────────────────────────────────┘   │
├─────────────────────────┴────────────────────────────────────────────┤
│                          최근 기록 로그                                │
│  ┌────────────────────────────────────────────────────────────────┐  │
│  │ 12:30:01 │ +10강 → +11강 │ 🟢 성공 │ 150,000 → 70,000        │  │
│  │ 12:30:03 │ +11강 → +11강 │ 🟡 유지 │ 70,000 → -80,000        │  │
│  │ 12:30:05 │ +11강 → 0강   │ 🔴 파괴 │ -80,000 → -80,000       │  │
│  │ 12:30:07 │ +0강 → +1강   │ 🟢 성공 │ -80,000 → -80,100       │  │
│  └────────────────────────────────────────────────────────────────┘  │
├──────────────────────────────────────────────────────────────────────┤
│  [▶ 시작]  [⏸ 일시정지]  [■ 정지]  [⚙ 설정]  [📊 내보내기]  [❌ 종료]  │
└──────────────────────────────────────────────────────────────────────┘
```

### 11.3 실시간 업데이트 메커니즘

```
┌─────────────────────────────────────────────────────────────┐
│                    실시간 업데이트 흐름                        │
└─────────────────────────────────────────────────────────────┘

┌───────────────┐      ┌───────────────┐      ┌───────────────┐
│  MacroRunner  │      │ StatsCollector │      │   GUIUpdater  │
│   (Thread)    │      │                │      │   (Main)      │
└───────┬───────┘      └───────┬───────┘      └───────┬───────┘
        │                      │                      │
        │  강화 결과 발생       │                      │
        │─────────────────────▶│                      │
        │                      │                      │
        │                      │  통계 업데이트        │
        │                      │─────────────────────▶│
        │                      │                      │
        │                      │      ┌───────────────┤
        │                      │      │ after(500ms)  │
        │                      │      │ 콜백 예약     │
        │                      │      └───────────────┤
        │                      │                      │
        │                      │                      │ UI 컴포넌트
        │                      │                      │ 업데이트
        │                      │                      │───────────▶
        │                      │                      │
        │                      │                      │
        ▼                      ▼                      ▼
     [계속]                 [계속]               [500ms 후 반복]


# 업데이트 주기
- 상태 패널: 500ms
- 통계 패널: 500ms
- 차트: 1000ms (성능 고려)
- 로그 패널: 즉시 (이벤트 기반)
```

### 11.4 쓰레드 안전성

```
┌─────────────────────────────────────────────────────────────┐
│                    쓰레드 간 통신                             │
└─────────────────────────────────────────────────────────────┘

┌─────────────────┐                        ┌─────────────────┐
│  매크로 쓰레드   │                        │   GUI 쓰레드     │
│  (Background)   │                        │   (Main)        │
└────────┬────────┘                        └────────┬────────┘
         │                                          │
         │     ┌──────────────────────┐            │
         │     │   Thread-Safe Queue   │            │
         │     │                      │            │
         │────▶│  - 상태 업데이트       │────────────▶│
         │     │  - 강화 결과          │            │
         │     │  - 에러 메시지        │            │
         │     └──────────────────────┘            │
         │                                          │
         │                                          │
         │     ┌──────────────────────┐            │
         │     │   Event Object       │            │
         │     │                      │            │
         │◀────│  - 시작/정지 신호     │◀───────────│
         │     │  - 설정 변경         │            │
         │     └──────────────────────┘            │
         │                                          │
         ▼                                          ▼

# Tkinter 규칙: GUI 업데이트는 반드시 메인 쓰레드에서
# root.after() 메서드로 메인 쓰레드에 작업 예약
```

### 11.5 차트 구현 세부사항

```python
# 레벨별 확률 막대 차트 (matplotlib + tkinter 연동)

class LevelProbabilityChart:
    def __init__(self, parent: tk.Frame):
        # Figure 생성 (차트 컨테이너)
        self.figure = Figure(figsize=(6, 4), dpi=100)
        self.ax = self.figure.add_subplot(111)

        # Tkinter Canvas에 연결
        self.canvas = FigureCanvasTkAgg(self.figure, parent)
        self.canvas.get_tk_widget().pack(fill=tk.BOTH, expand=True)

        # 색상 정의
        self.colors = {
            'success': '#4CAF50',   # 초록
            'maintain': '#FFC107',  # 노랑
            'destroy': '#F44336',   # 빨강
        }

    def update(self, level_stats: Dict[int, LevelStats]) -> None:
        """차트 데이터 업데이트"""
        self.ax.clear()

        if not level_stats:
            self.ax.text(0.5, 0.5, '데이터 없음',
                        ha='center', va='center')
            self.canvas.draw()
            return

        # 데이터 준비
        levels = sorted(level_stats.keys())
        x = np.arange(len(levels))
        width = 0.25

        success = [level_stats[l].success_rate * 100 for l in levels]
        maintain = [level_stats[l].maintain_rate * 100 for l in levels]
        destroy = [level_stats[l].destroy_rate * 100 for l in levels]

        # 막대 그래프 그리기
        self.ax.bar(x - width, success, width,
                   label='성공', color=self.colors['success'])
        self.ax.bar(x, maintain, width,
                   label='유지', color=self.colors['maintain'])
        self.ax.bar(x + width, destroy, width,
                   label='파괴', color=self.colors['destroy'])

        # 레이블 설정
        self.ax.set_xlabel('강화 레벨')
        self.ax.set_ylabel('확률 (%)')
        self.ax.set_title('레벨별 강화 결과 분포')
        self.ax.set_xticks(x)
        self.ax.set_xticklabels([f'+{l}' for l in levels])
        self.ax.legend()
        self.ax.set_ylim(0, 100)

        # 화면 갱신
        self.figure.tight_layout()
        self.canvas.draw()
```

---

## 요약

### 핵심 동작 사이클 (Phase 1-5 통합)

```
1. 입력 감지 (Hotkey / Auto Loop / GUI Button)
       ↓
2. 상태 읽기 (Clipboard → Parser)
       ↓
3. 통계 기록 (StatsCollector.record())  ← Phase 4
       ↓
4. 결정 (Strategy.decide())
       ↓
5. 실행 (Actions → Automation)
       ↓
6. GUI 업데이트 (GUIUpdater → Panels)  ← Phase 5
       ↓
7. 대기 (Sleep)
       ↓
   (반복)
```

### 주요 설계 원칙

| 원칙 | 설명 |
|------|------|
| **모듈화** | 각 기능을 독립 모듈로 분리 |
| **설정 분리** | 좌표, 파라미터를 config로 외부화 |
| **안전 우선** | 에러 처리, 비상 정지 기능 |
| **확장성** | Strategy 패턴으로 전략 교체 용이 |
| **관측성** | 통계 수집으로 실제 확률 검증 |
| **사용성** | GUI로 실시간 모니터링 |
